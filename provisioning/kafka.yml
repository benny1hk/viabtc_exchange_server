---
- hosts: all
  vars:
    kafka_version: 2.0.1
    kafka: kafka_2.11-{{ kafka_version }}
  become: true
  gather_facts: False
  pre_tasks:
    # Ansible requires python2, which is not installed by default on Ubuntu Xenial
    - raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
    # action: setup will gather facts after python2 has been installed
    - action: setup
  tasks:

    - name: add java repo
      apt_repository: repo="ppa:webupd8team/java"

    - name: accept java8 license
      debconf: name=oracle-java8-installer question=shared/accepted-oracle-license-v1-1 value=true vtype=select

    - name: install java8
      apt: name={{item}} state=latest
      with_items:
        - oracle-java8-installer
        - ca-certificates
        - oracle-java8-set-default

    - name: install zookeeper
      apt: pkg=zookeeperd state=present

    - name: download kafka
      get_url:
        url: http://www-us.apache.org/dist/kafka/{{kafka_version}}/{{kafka}}.tgz
        dest: /tmp/{{kafka}}.tgz
        checksum: sha512:0F47A45034F3F5FE25AF30F8C2B5746CEB1AB2A40DF6D1E5CB238B677B9C6A9B5FD11478099158AB0FB85F3C035FEB03BEAAA9EC7A7CAB88FD26F74CE55AE6BA

    - name: create kafka directory
      file:
        path: /opt/kafka
        state: directory

    - name: extract kafka .tgz into /opt/kafka
      unarchive:
        copy: no
        src: /tmp/{{kafka}}.tgz
        dest: /opt/kafka

    - name: set kafka advertized listener
      replace:
        path: /opt/kafka/{{kafka}}/config/server.properties
        regexp: '#(advertised.listeners=).*(:9092)'
        replace: '\1PLAINTEXT://{{kafka_advertised_listener}}\2'

    - name: install kafka systemd service
      template: src=templates/kafka.j2 dest=/etc/systemd/system/kafka.service

    - name: stop kafka
      systemd: state=stopped name=kafka
      ignore_errors: yes

    - name: start kafka
      systemd: state=started enabled=yes name=kafka daemon_reload=yes
